<html> 
    <head> 
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/> 
        <title>Physics</title> 
        <script type="text/javascript" src="../box2d/Box2d.min.js"></script>
        <script type="text/javascript" src="../kernel/Physics.js"></script>

        <script type="text/javascript" src="../kernel/Settings.js"></script>
        <script type="text/javascript" src="../kernel/Time.js"></script>
        <script type="text/javascript" src="../kernel/Input.js"></script>

        <script type="text/javascript" src="../kernel/Application.js"></script>
        <script type="text/javascript" src="../kernel/Utils.js"></script>
        <script type="text/javascript" src="../kernel/Script.js"></script>
        <script type="text/javascript" src="../kernel/Sound.js"></script>


        <script type="text/javascript" src="../kernel/GameObject.js"></script>        



        <script type="text/javascript" src="../components/Sprite.js"></script> 
        <script type="text/javascript" src="../components/TileMap.js"></script>
        <script type="text/javascript" src="../components/ColliderTileMap.js"></script>
        <script type="text/javascript" src="../components/Collider.js"></script>

        <script type="text/javascript">
            /**
             * Physics test screen level.
             * @author Thiago Campos Viana
             */

            function PhysicsTest() {
                this.name="Physics";
		
                this.start=function(){	
	
                    Settings.tileHeight=16;
                    Settings.tileWidth=16;
                    Settings.physicsScale=16;
        
                    Physics.startDebug();
                    Physics.world.SetGravity(new b2Vec2(0, 20));
        
        


                    this.mychild=new GameObject();
                    this.mychild.x=0;
                    this.mychild.y=0;
		

		
                    collidermap=[	[-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],
                        [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],
                        [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],
                        [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],
                        [-1,0,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],
                        [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],
                        [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],
                        [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],
                        [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],
                        [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],
                        [-1,-1,-1,0,1,1,1,1,2,-1,-1,-1,0,1,1,2,-1,-1,-1,-1],
                        [-1,-1,-1,0,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],
                        [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],
                        [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],
                        [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1]
                    ];
		
                    this.mychild.insertScript(new ColliderTileMap(collidermap));
		
                    this.tileObj=new GameObject();
                    this.insertChild(this.tileObj);
                    tileMap=[
                        [5,5,5,5,5,4,5,5,5,5,5,5,5,5,5,5,5,5,5,5],
                        [5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,4,5,5,5,5],
                        [5,3,5,5,3,5,5,4,5,3,5,4,5,5,5,5,5,3,5,5],
                        [5,5,4,5,5,5,5,5,5,5,5,5,5,5,5,5,3,5,5,5],
                        [5,5,5,5,3,5,5,4,5,5,5,5,4,5,5,5,5,5,5,5],
                        [5,3,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5],
                        [5,5,5,5,5,5,5,5,5,3,5,5,5,5,5,4,5,5,5,5],
                        [5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5],
                        [5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5],
                        [5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5],
                        [5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5],
                        [5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5],
                        [5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5],
                        [5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5],
                        [5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5]
                    ];
                    this.tileObj.insertScript(new TileMap('res/tileset2.png',tileMap));
                    tileMap=[
                        [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],
                        [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],
                        [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],
                        [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],
                        [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],
                        [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],
                        [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],
                        [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],
                        [-1,-1,-1,-1,18,19,20,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],
                        [-1,-1,-1,-1,36,35,36,-1,-1,-1,-1,-1,-1,36,-1,-1,-1,-1,-1,-1],
                        [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],
                        [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],
                        [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],
                        [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],
                        [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1]
                    ];
                    this.tileObj.insertScript(new TileMap('res/tileset2.png',tileMap));
                    tileMap=[
                        [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],
                        [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],
                        [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],
                        [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],
                        [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],
                        [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],
                        [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],
                        [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],
                        [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],
                        [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],
                        [-1,-1,-1,1,1,1,1,1,1,-1,-1,-1,1,1,1,1,-1,-1,-1,-1],
                        [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],
                        [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],
                        [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],
                        [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1]
                    ];
                    this.tileObj.insertScript(new TileMap('res/tileset2.png',tileMap));
        
        
                    animation={
                        right:[5,6,7,6],
                        left:[0,1,2,1],
                        upL:[8],
                        upR:[15],
                        idleL:[3],
                        idleR:[4]
                    };
                    sprite=new Sprite('res/charsheet3.png',animation,'idleR',16,16);
                    
                    spriteObj=new GameObject(); 
                    spriteObj.x=0;
                    this.insertChild(spriteObj);
                    spriteObj.insertScript(sprite);
                    collider=new Collider(16,16);
                    spriteObj.insertScript(collider);
                    collider.setFixedRotation(true);
                    collider.body.SetSleepingAllowed(false);
        
                    sprite.lastPos='R';
        
                    sprite.update=function() {
                        this.play=true;
                        yv=this.parent.collider.body.GetLinearVelocity().y;
                        xv=this.parent.collider.body.GetLinearVelocity().x;
                        if(Input.isKeyDown_right){
                            if(this.animPos!='right' && yv==0)this.setAnimation('right'); 
                            this.parent.collider.body.SetLinearVelocity({
                                x:4,
                                y:yv
                            });
                            this.lastPos='R';

                        } else if( Input.isKeyDown_left ){
                            if(this.animPos!='left' && yv==0)this.setAnimation('left');
                            this.parent.collider.body.SetLinearVelocity({
                                x:-4,
                                y:yv
                            });
                            this.lastPos='L';

                        } else {
                            if( yv==0) this.setAnimation('idle'+this.lastPos);
                            this.parent.collider.body.SetLinearVelocity({
                                x:0,
                                y:yv
                            });

                            this.play=false;

                        }
                        
                        if(Input.isKeyDown_space){
                
                            if(yv==0){
                                Sound.play('res/jump.wav');

                                this.parent.collider.body.ApplyImpulse(
                                {
                                    x:0,
                                    y:200
                                },this.parent.collider.body.GetLocalCenter());
                                this.play=true;
                            }
                            this.setAnimation('up'+this.lastPos);

                        }
            
                        if(xv>1 && yv!=0)this.setAnimation('upR'); 
                        else if(xv<-1 && yv!=0)this.setAnimation('upL'); 
						
                        						
						
                    };
        
                    spriteObj.onCollisionEnter=function(other){
                        yv=this.collider.body.GetLinearVelocity().y;
                        xv=this.collider.body.GetLinearVelocity().x;
                        if(yv==0){
                            this.sprite.setAnimation('idle'+this.sprite.lastPos);
                        }          

        
                    }

        

		
                },

    
                this.onCollisionEnter=function(other){
        
        

        
                },
    
                this.onCollisionStay=function(other){
        
        
                },
    
                this.onCollisionExit=function(other){
        
                    console.log('hit end');
        
                },
	


                this.update=function() {
        

                }
    
    
	

            }

            PhysicsTest.prototype = new GameObject;
        </script>
    </head> 
    <body id="home"> 
        <canvas id="canvas" width="600" height="400"></canvas>
        <p>up=static,down=dynamic,space=set shape</p>

        <script type="text/javascript">
            Application.run('canvas','PhysicsTest');			
        </script>	
    </body> 
</html>  			